<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dictionary Service Test</title>
  <meta name="theme-color" content="#667eea">
  <link rel="icon" type="image/png" href="img/favicon.png">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <link rel="manifest" href="manifest.json">
  <script>if('serviceWorker' in navigator){window.addEventListener('load',()=>{navigator.serviceWorker.register('./sw.js').then(r=>r.update())})}</script>
  <link rel="stylesheet" href="css/mobile-optimized.css">
  <style>
    .test-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .test-section h2 {
      color: var(--primary);
      margin-bottom: 15px;
      border-bottom: 2px solid var(--primary);
      padding-bottom: 10px;
    }
    .status-box {
      background: #f5f5f5;
      border-radius: 4px;
      padding: 15px;
      font-family: monospace;
      white-space: pre-wrap;
      overflow-x: auto;
    }
    .source-card {
      display: inline-block;
      background: #e8f4f8;
      border-radius: 6px;
      padding: 10px 15px;
      margin: 5px;
      border-left: 4px solid var(--primary);
    }
    .source-card.loaded {
      border-left-color: var(--success);
      background: #e8f8e8;
    }
    .lookup-input {
      width: 100%;
      max-width: 300px;
      padding: 12px;
      font-size: 18px;
      border: 2px solid #ddd;
      border-radius: 6px;
      margin-bottom: 15px;
    }
    .lookup-input:focus {
      border-color: var(--primary);
      outline: none;
    }
    .result-card {
      background: #f9f9f9;
      border-radius: 6px;
      padding: 15px;
      margin: 10px 0;
      border-right: 4px solid var(--primary);
    }
    .result-card .source {
      font-size: 12px;
      color: #666;
      background: #eee;
      padding: 2px 8px;
      border-radius: 4px;
      display: inline-block;
      margin-bottom: 10px;
    }
    .result-card .word {
      font-size: 24px;
      font-weight: bold;
      color: var(--primary);
    }
    .result-card .root {
      font-size: 18px;
      color: var(--success);
    }
    .result-card .definitions {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #ddd;
    }
    .result-card .definition {
      margin: 5px 0;
      padding-right: 10px;
      border-right: 2px solid #ccc;
    }
    .checkbox-group {
      margin: 10px 0;
    }
    .checkbox-group label {
      margin-left: 15px;
      cursor: pointer;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .stat-box {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-box .value {
      font-size: 28px;
      font-weight: bold;
    }
    .stat-box .label {
      font-size: 12px;
      opacity: 0.9;
    }
    #loadingIndicator {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <header class="mobile-header">
    <div class="mobile-header-inner">
      <a href="index.html" class="logo">Dictionary Test</a>
    </div>
  </header>

  <main class="container">
    <h1>Hebrew Dictionary Service Test</h1>
    <p>Testing multi-source dictionary with separate provenance tracking.</p>

    <!-- Loading Indicator -->
    <div id="loadingIndicator">
      <div class="spinner"></div>
      <div>Loading dictionaries...</div>
    </div>

    <!-- Main Content (hidden until loaded) -->
    <div id="mainContent" style="display: none;">

      <!-- Status Section -->
      <section class="test-section">
        <h2>Dictionary Sources</h2>
        <div id="sourcesContainer"></div>
        <div class="stats-grid" id="statsGrid"></div>
      </section>

      <!-- Lookup Section -->
      <section class="test-section">
        <h2>Word Lookup</h2>
        <input type="text" id="lookupInput" class="lookup-input" placeholder="Enter Hebrew word..." value="אבד">

        <div class="checkbox-group">
          <strong>Search in:</strong>
          <label><input type="checkbox" id="srcUnified" checked> Unified (82K, merged)</label>
          <label><input type="checkbox" id="srcBdb"> BDB (verified)</label>
          <label><input type="checkbox" id="srcWiktionary"> Wiktionary (community)</label>
          <label><input type="checkbox" id="srcTanakh"> Tanakh (heuristic)</label>
        </div>

        <button id="lookupBtn" class="btn" style="padding: 10px 20px;">Look Up</button>

        <div id="lookupResults"></div>
      </section>

      <!-- Search Section -->
      <section class="test-section">
        <h2>Search by Root</h2>
        <input type="text" id="rootInput" class="lookup-input" placeholder="Enter root (e.g., אבד)..." value="אבד">
        <button id="searchRootBtn" class="btn" style="padding: 10px 20px;">Find Words with Root</button>
        <div id="rootResults"></div>
      </section>

      <!-- Era Search Section -->
      <section class="test-section">
        <h2>Search by Era</h2>
        <p>Browse words by historical period (from unified dictionary):</p>
        <div class="checkbox-group">
          <button id="eraBiblical" class="btn" style="padding: 8px 15px; margin: 5px;">Biblical</button>
          <button id="eraRabbinic" class="btn" style="padding: 8px 15px; margin: 5px;">Rabbinic</button>
          <button id="eraMedieval" class="btn" style="padding: 8px 15px; margin: 5px;">Medieval</button>
          <button id="eraModern" class="btn" style="padding: 8px 15px; margin: 5px;">Modern</button>
        </div>
        <div id="eraResults"></div>
      </section>

      <!-- Comparison Section -->
      <section class="test-section">
        <h2>Source Comparison</h2>
        <p>Words unique to each source vs. overlap:</p>
        <div id="comparisonResults"></div>
      </section>

    </div>
  </main>

  <script type="module">
    import { getDictionaryService, initDictionaries } from './engines/dictionary-service.js';

    let dictService;

    async function init() {
      try {
        // Initialize dictionaries (including unified)
        const status = await initDictionaries(['unified', 'bdb', 'wiktionary', 'tanakh']);
        dictService = getDictionaryService();

        // Also load inflection map
        await dictService.loadInflectionMap();

        // Hide loading, show content
        document.getElementById('loadingIndicator').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';

        // Display status
        displayStatus(status);

        // Set up event listeners
        document.getElementById('lookupBtn').addEventListener('click', doLookup);
        document.getElementById('lookupInput').addEventListener('keypress', e => {
          if (e.key === 'Enter') doLookup();
        });

        document.getElementById('searchRootBtn').addEventListener('click', doRootSearch);
        document.getElementById('rootInput').addEventListener('keypress', e => {
          if (e.key === 'Enter') doRootSearch();
        });

        // Era search buttons
        document.getElementById('eraBiblical').addEventListener('click', () => doEraSearch('biblical'));
        document.getElementById('eraRabbinic').addEventListener('click', () => doEraSearch('rabbinic'));
        document.getElementById('eraMedieval').addEventListener('click', () => doEraSearch('medieval'));
        document.getElementById('eraModern').addEventListener('click', () => doEraSearch('modern'));

        // Initial lookup
        doLookup();

        // Calculate comparison
        calculateComparison();

      } catch (error) {
        console.error('Init failed:', error);
        document.getElementById('loadingIndicator').innerHTML =
          `<div style="color: red;">Error: ${error.message}</div>`;
      }
    }

    function displayStatus(status) {
      // Sources
      const sourcesHtml = Object.entries(status.sources).map(([id, info]) => `
        <div class="source-card loaded">
          <strong>${info.name}</strong><br>
          <small>${info.count.toLocaleString()} entries</small><br>
          <small>License: ${info.license}</small>
        </div>
      `).join('');
      document.getElementById('sourcesContainer').innerHTML = sourcesHtml;

      // Stats
      const statsHtml = `
        <div class="stat-box">
          <div class="value">${status.totalWords.toLocaleString()}</div>
          <div class="label">Total Words</div>
        </div>
        <div class="stat-box">
          <div class="value">${Object.keys(status.sources).length}</div>
          <div class="label">Sources Loaded</div>
        </div>
      `;
      document.getElementById('statsGrid').innerHTML = statsHtml;
    }

    function doLookup() {
      const word = document.getElementById('lookupInput').value.trim();
      if (!word) return;

      const sources = [];
      if (document.getElementById('srcUnified').checked) sources.push('unified');
      if (document.getElementById('srcBdb').checked) sources.push('bdb');
      if (document.getElementById('srcWiktionary').checked) sources.push('wiktionary');
      if (document.getElementById('srcTanakh').checked) sources.push('tanakh');

      const results = dictService.lookup(word, sources.length ? sources : null);

      // Also check inflection map for lemma
      const lemmaInfo = dictService.getLemma(word);

      if (results.length === 0) {
        document.getElementById('lookupResults').innerHTML =
          '<p style="color: #666;">No results found in selected sources.</p>';
        return;
      }

      // Show lemma info if available
      let lemmaHtml = '';
      if (lemmaInfo) {
        lemmaHtml = `
          <div style="background: #fff3cd; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
            <strong>Inflection Mapping:</strong> This is an inflected form of lemma
            <strong style="color: var(--primary);">${lemmaInfo.lemma}</strong>
            (root: <strong style="color: var(--success);">${lemmaInfo.root}</strong>)
          </div>
        `;
      }

      const html = lemmaHtml + results.map(r => `
        <div class="result-card">
          <span class="source">${r.sourceName} (${r.source})</span>
          ${r.era ? `<span class="source" style="background: #e8f4e8; margin-right: 5px;">${r.era}</span>` : ''}
          ${r.type && r.type !== 'native' ? `<span class="source" style="background: #f8e8e8; margin-right: 5px;">${r.type}</span>` : ''}
          <div class="word">${r.word}</div>
          ${r.root ? `<div class="root">Root: ${r.root}</div>` : ''}
          ${r.pos ? `<div>POS: ${r.pos}</div>` : ''}
          ${r.binyan ? `<div>Binyan: ${r.binyan}</div>` : ''}
          ${r.confidence ? `<div>Confidence: ${(r.confidence * 100).toFixed(0)}%</div>` : ''}
          ${r.originalSources && r.originalSources.length > 0 ? `
            <div style="margin-top: 8px; font-size: 12px;">
              <strong>Found in:</strong> ${r.originalSources.join(', ')}
            </div>
          ` : ''}
          ${r.definitions && r.definitions.length > 0 ? `
            <div class="definitions">
              <strong>Definitions:</strong>
              ${r.definitions.map(d => `<div class="definition">${d}</div>`).join('')}
            </div>
          ` : ''}
          ${r.refs && r.refs.length > 0 ? `
            <div style="margin-top: 10px; font-size: 12px; color: #666;">
              Refs: ${r.refs.slice(0, 3).join(', ')}${r.refs.length > 3 ? '...' : ''}
            </div>
          ` : ''}
          ${r.related && r.related.length > 0 ? `
            <div style="margin-top: 10px; font-size: 12px;">
              Related: ${r.related.slice(0, 5).join(', ')}
            </div>
          ` : ''}
        </div>
      `).join('');

      document.getElementById('lookupResults').innerHTML = html;
    }

    function doRootSearch() {
      const root = document.getElementById('rootInput').value.trim();
      if (!root) return;

      const results = dictService.search({ root, limit: 20 });

      if (results.length === 0) {
        document.getElementById('rootResults').innerHTML =
          '<p style="color: #666;">No words found with this root.</p>';
        return;
      }

      const html = `
        <p>Found ${results.length} words with root <strong>${root}</strong>:</p>
        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
          ${results.map(r => `
            <div style="background: #f0f0f0; padding: 8px 12px; border-radius: 4px;">
              <strong>${r.word}</strong>
              <small style="color: #666;">(${r.source})</small>
              ${r.pos ? `<br><small>${r.pos}</small>` : ''}
            </div>
          `).join('')}
        </div>
      `;

      document.getElementById('rootResults').innerHTML = html;
    }

    function doEraSearch(era) {
      const results = dictService.searchByEra(era, 30);

      if (results.length === 0) {
        document.getElementById('eraResults').innerHTML =
          `<p style="color: #666;">No ${era} words found.</p>`;
        return;
      }

      const eraLabels = {
        biblical: 'Biblical (תנ"ך)',
        rabbinic: 'Rabbinic (חז"ל)',
        medieval: 'Medieval (ימה"ב)',
        modern: 'Modern (חדשה)'
      };

      const html = `
        <p>Found ${results.length} <strong>${eraLabels[era]}</strong> words (showing sample):</p>
        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
          ${results.map(r => `
            <div style="background: #f0f0f0; padding: 8px 12px; border-radius: 4px; cursor: pointer;"
                 onclick="document.getElementById('lookupInput').value='${r.word}'; document.querySelector('#lookupBtn').click();">
              <strong>${r.word}</strong>
              ${r.root ? `<br><small style="color: var(--success);">שורש: ${r.root}</small>` : ''}
              ${r.pos ? `<br><small style="color: #666;">${r.pos}</small>` : ''}
            </div>
          `).join('')}
        </div>
      `;

      document.getElementById('eraResults').innerHTML = html;
    }

    function calculateComparison() {
      const unifiedWords = dictService.getAllWords(['unified']);
      const bdbWords = dictService.getAllWords(['bdb']);
      const wiktionaryWords = dictService.getAllWords(['wiktionary']);
      const tanakhWords = dictService.getAllWords(['tanakh']);

      // Calculate unique total from individual sources
      const allIndividual = new Set([...bdbWords, ...wiktionaryWords, ...tanakhWords]);

      // Calculate overlaps
      let inAll = 0;
      let bdbAndWikt = 0;
      let bdbAndTanakh = 0;
      let wiktAndTanakh = 0;

      for (const word of allIndividual) {
        const inBdb = bdbWords.has(word);
        const inWikt = wiktionaryWords.has(word);
        const inTanakh = tanakhWords.has(word);

        if (inBdb && inWikt && inTanakh) inAll++;
        else if (inBdb && inWikt) bdbAndWikt++;
        else if (inBdb && inTanakh) bdbAndTanakh++;
        else if (inWikt && inTanakh) wiktAndTanakh++;
      }

      const html = `
        <div class="stats-grid">
          <div class="stat-box" style="background: linear-gradient(135deg, #00b09b, #96c93d);">
            <div class="value">${unifiedWords.size.toLocaleString()}</div>
            <div class="label">UNIFIED (merged)</div>
          </div>
          <div class="stat-box" style="background: linear-gradient(135deg, #667eea, #764ba2);">
            <div class="value">${bdbWords.size.toLocaleString()}</div>
            <div class="label">BDB</div>
          </div>
          <div class="stat-box" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
            <div class="value">${wiktionaryWords.size.toLocaleString()}</div>
            <div class="label">Wiktionary</div>
          </div>
          <div class="stat-box" style="background: linear-gradient(135deg, #ee0979, #ff6a00);">
            <div class="value">${tanakhWords.size.toLocaleString()}</div>
            <div class="label">Tanakh</div>
          </div>
        </div>
        <p style="margin-top: 15px; color: #666;">
          <strong>Overlap Analysis (individual sources):</strong><br>
          • In all 3 sources: ${inAll.toLocaleString()} (highest confidence)<br>
          • BDB + Wiktionary: ${bdbAndWikt.toLocaleString()}<br>
          • BDB + Tanakh: ${bdbAndTanakh.toLocaleString()}<br>
          • Wiktionary + Tanakh: ${wiktAndTanakh.toLocaleString()}<br><br>
          <strong>Unified dictionary:</strong> ${unifiedWords.size.toLocaleString()} unique words (deduplicated superset)<br>
          <strong>Inflection mappings:</strong> ~50,000 (linking inflected forms to lemmas)
        </p>
      `;

      document.getElementById('comparisonResults').innerHTML = html;
    }

    // Initialize on load
    init();
  </script>
</body>
</html>
