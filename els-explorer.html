<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ELS Explorer</title>
  <link rel="stylesheet" href="css/mobile-optimized.css">
  <style>
    :root {
      --els-blue: #1e5aa8;
      --els-blue-light: #e8f0f8;
      --els-gray: #555;
      --els-border: #ccc;
    }
    .section {
      background: white;
      border-radius: 6px;
      padding: 20px;
      margin-bottom: 16px;
      border: 1px solid var(--els-border);
    }
    .section h2 {
      color: var(--els-blue);
      margin-bottom: 12px;
      font-size: 18px;
      border-bottom: 1px solid var(--els-border);
      padding-bottom: 8px;
    }
    .input-row {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .input-row input {
      padding: 10px;
      font-size: 16px;
      border: 1px solid var(--els-border);
      border-radius: 4px;
      min-width: 120px;
    }
    .input-row input:focus {
      border-color: var(--els-blue);
      outline: none;
    }
    .btn {
      padding: 10px 20px;
      cursor: pointer;
      background: var(--els-blue);
      color: white;
      border: none;
      border-radius: 4px;
    }
    .btn:hover {
      background: #174a8a;
    }
    .btn-small {
      padding: 8px 12px;
      font-size: 14px;
    }
    .btn-secondary {
      background: var(--els-gray);
      color: white;
      border: none;
      border-radius: 4px;
    }
    .btn-success {
      background: #2e7d32;
      color: white;
      border: none;
      border-radius: 4px;
    }
    .btn-danger {
      background: #c62828;
      color: white;
      border: none;
      border-radius: 4px;
    }
    .results {
      background: #fafafa;
      border-radius: 4px;
      padding: 15px;
      margin-top: 15px;
      border: 1px solid var(--els-border);
    }
    .results-scrollable {
      max-height: 600px;
      overflow-y: auto;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    .stat-box {
      background: var(--els-blue);
      color: white;
      padding: 14px;
      border-radius: 4px;
      text-align: center;
    }
    .stat-box .value {
      font-size: 22px;
      font-weight: bold;
    }
    .stat-box .label {
      font-size: 12px;
      opacity: 0.9;
    }
    #loadingIndicator {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid #eee;
      border-top: 4px solid var(--els-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .proximity-matrix {
      overflow-x: auto;
      margin-top: 15px;
    }
    .proximity-matrix table {
      border-collapse: collapse;
      font-size: 14px;
      width: 100%;
    }
    .proximity-matrix th, .proximity-matrix td {
      border: 1px solid var(--els-border);
      padding: 8px 12px;
      text-align: center;
    }
    .proximity-matrix th {
      background: var(--els-blue);
      color: white;
    }
    .proximity-cell-close {
      background: #d4edda;
    }
    .proximity-cell-medium {
      background: #fff3cd;
    }
    .proximity-cell-far {
      background: #f8d7da;
    }

    /* Term entry styles */
    .term-entries {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 15px;
    }
    .term-entry {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .term-entry input {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      border: 1px solid var(--els-border);
      border-radius: 4px;
    }
    .term-entry input:focus {
      border-color: var(--els-blue);
      outline: none;
    }
    .term-entry .remove-btn {
      background: #c62828;
      color: white;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
    }
    .term-entry .remove-btn:hover {
      background: #a01818;
    }

    /* Save/Load panel */
    .save-load-panel {
      background: var(--els-blue-light);
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #c8dae8;
    }
    .saved-searches {
      margin-top: 10px;
    }
    .saved-search-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background: white;
      border-radius: 4px;
      margin-bottom: 5px;
      border: 1px solid var(--els-border);
    }
    .saved-search-item .terms {
      font-weight: bold;
      color: var(--els-blue);
    }
    .saved-search-item .timestamp {
      font-size: 11px;
      color: #666;
    }

    /* Full results table */
    .full-results-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .full-results-table th, .full-results-table td {
      border: 1px solid var(--els-border);
      padding: 8px;
      text-align: right;
    }
    .full-results-table th {
      background: var(--els-blue);
      color: white;
      position: sticky;
      top: 0;
    }
    .full-results-table tr:nth-child(even) {
      background: #f5f5f5;
    }
    .full-results-table tr:hover {
      background: var(--els-blue-light);
    }

    /* Action buttons row */
    .action-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    /* Clickable rows */
    .clickable-row {
      cursor: pointer;
      transition: background 0.15s;
    }
    .clickable-row:hover {
      background: #d0e4f7 !important;
    }
    .clickable-row.selected {
      background: var(--els-blue) !important;
      color: white;
    }
    .clickable-row.selected td {
      color: white;
    }

    /* Matrix view area */
    .matrix-view-area {
      margin-top: 20px;
      padding: 20px;
      background: #2a2a3d;
      border-radius: 6px;
      color: white;
    }
    .matrix-view-area h3 {
      color: #8bb8e8;
      margin-bottom: 10px;
    }
    .matrix-view-area .hint {
      color: #999;
      font-size: 13px;
    }

    /* ELS Matrix display */
    .els-matrix {
      font-family: 'Courier New', monospace;
      font-size: 16px;
      line-height: 1.8;
      direction: rtl;
      background: #1a1a28;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      white-space: pre;
      margin: 15px 0;
    }
    .els-matrix .highlight-term1 {
      background: #c62828;
      color: white;
      padding: 2px;
      border-radius: 2px;
    }
    .els-matrix .highlight-term2 {
      background: #2e7d32;
      color: white;
      padding: 2px;
      border-radius: 2px;
    }
    .els-matrix .highlight-both {
      background: #e65100;
      color: white;
      padding: 2px;
      border-radius: 2px;
    }
    .matrix-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    .matrix-stat {
      background: #3a3a4d;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
    }
    .matrix-stat .value {
      font-size: 18px;
      font-weight: bold;
      color: #8bb8e8;
    }
    .matrix-stat .label {
      font-size: 11px;
      color: #999;
    }
  </style>
</head>
<body>
  <header class="mobile-header">
    <div class="mobile-header-inner">
      <a href="index.html" class="logo">ELS Explorer</a>
    </div>
  </header>

  <main class="container">
    <h1>ELS Explorer</h1>
    <p>Multi-term proximity search with session save/load.</p>

    <!-- Loading Indicator -->
    <div id="loadingIndicator">
      <div class="spinner"></div>
      <div>Loading ELS Index...</div>
      <div id="loadProgress" style="margin-top: 10px; font-size: 12px;"></div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" style="display: none;">

      <!-- Index Stats -->
      <section class="section">
        <h2>Index Statistics</h2>
        <div class="stats-grid" id="statsGrid"></div>
      </section>

      <!-- Multi-Term Search -->
      <section class="section">
        <h2>Multi-Term Search</h2>

        <!-- Save/Load Panel -->
        <div class="save-load-panel">
          <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
            <input type="text" id="sessionName" placeholder="Session name..." style="flex: 1; min-width: 150px; padding: 8px;">
            <button class="btn btn-success btn-small" onclick="saveSession()">Save Session</button>
            <button class="btn btn-secondary btn-small" onclick="exportResults()">Export JSON</button>
            <button class="btn btn-secondary btn-small" onclick="clearSession()">Clear All</button>
          </div>
          <div class="saved-searches" id="savedSearches"></div>
        </div>

        <!-- Term Entry Boxes -->
        <div class="term-entries" id="termEntries">
          <div class="term-entry">
            <input type="text" class="term-input" placeholder="Term 1 (e.g., משה)" value="משה">
            <button class="remove-btn" onclick="removeTerm(this)" title="Remove term">&times;</button>
          </div>
          <div class="term-entry">
            <input type="text" class="term-input" placeholder="Term 2 (e.g., אהרן)" value="אהרן">
            <button class="remove-btn" onclick="removeTerm(this)" title="Remove term">&times;</button>
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn btn-secondary" onclick="addTerm()">+ Add Term</button>
          <button class="btn" onclick="searchAllTerms()">Search All Terms</button>
        </div>

        <!-- Results Display -->
        <div id="searchResults"></div>
      </section>

      <!-- Individual Word Lookup -->
      <section class="section">
        <h2>Individual Word Lookup</h2>
        <div class="input-row">
          <input type="text" id="lookupWord" placeholder="Hebrew word" value="ישראל">
          <input type="number" id="lookupLimit" placeholder="Max results" value="100" style="width: 100px;">
          <button class="btn" onclick="doLookup()">Look Up</button>
        </div>
        <div id="lookupResults"></div>
      </section>

      <!-- Proximity Search -->
      <section class="section">
        <h2>Proximity Search by Position</h2>
        <p>Find all words near a specific Torah position:</p>
        <div class="input-row">
          <input type="number" id="proximityPos" placeholder="Position" value="50000">
          <input type="number" id="proximityRadius" placeholder="Radius" value="500">
          <input type="number" id="proximityLimit" placeholder="Max results" value="50">
          <button class="btn" onclick="doProximitySearch()">Search</button>
        </div>
        <div id="proximityResults"></div>
      </section>

      <!-- Cluster Discovery -->
      <section class="section">
        <h2>Cluster Discovery</h2>
        <p>Discover term clusters around a seed word:</p>
        <div class="input-row">
          <input type="text" id="clusterSeed" placeholder="Seed word" value="אברהם">
          <input type="number" id="clusterRadius" placeholder="Radius" value="1000">
          <input type="number" id="clusterLimit" placeholder="Max terms" value="30">
          <button class="btn" onclick="doClusterDiscovery()">Discover</button>
        </div>
        <div id="clusterResults"></div>
      </section>

      <!-- Statistical Significance -->
      <section class="section">
        <h2>Statistical Significance</h2>
        <p>Calculate observed vs expected occurrences:</p>
        <div class="input-row">
          <input type="text" id="sigWord" placeholder="Word" value="תורה">
          <button class="btn" onclick="doSignificance()">Calculate</button>
        </div>
        <div id="sigResults"></div>
      </section>

    </div>
  </main>

  <script type="module">
    import { getElsIndexService, initElsIndex } from './engines/els-index.js';

    let elsService;
    let currentResults = null;
    let torahText = null;

    async function init() {
      try {
        document.getElementById('loadProgress').textContent = 'Loading Torah text...';
        const torahResponse = await fetch('data/torahNoSpaces.txt');
        torahText = await torahResponse.text();

        document.getElementById('loadProgress').textContent = 'Fetching ELS index...';
        const metadata = await initElsIndex('data/els-index/els-index-50-min4.json.gz');
        elsService = getElsIndexService();

        document.getElementById('loadingIndicator').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';

        displayStats(metadata);
        loadSavedSearches();

      } catch (error) {
        console.error('Init failed:', error);
        document.getElementById('loadingIndicator').innerHTML =
          `<div style="color: red;">Error: ${error.message}<br><br>
          Make sure the ELS index file exists at data/els-index/els-index-50-min4.json.gz</div>`;
      }
    }

    function displayStats(metadata) {
      const html = `
        <div class="stat-box">
          <div class="value">${metadata.total_words?.toLocaleString() || 'N/A'}</div>
          <div class="label">Words Indexed</div>
        </div>
        <div class="stat-box">
          <div class="value">${metadata.total_occurrences?.toLocaleString() || 'N/A'}</div>
          <div class="label">Total Occurrences</div>
        </div>
        <div class="stat-box">
          <div class="value">${metadata.skip_range ? `±${metadata.skip_range[1]}` : 'N/A'}</div>
          <div class="label">Skip Range</div>
        </div>
        <div class="stat-box">
          <div class="value">${metadata.torah_length?.toLocaleString() || 'N/A'}</div>
          <div class="label">Torah Letters</div>
        </div>
      `;
      document.getElementById('statsGrid').innerHTML = html;
    }

    // =============== Multi-Term Search ===============

    window.addTerm = function() {
      const container = document.getElementById('termEntries');
      const count = container.querySelectorAll('.term-entry').length + 1;
      const entry = document.createElement('div');
      entry.className = 'term-entry';
      entry.innerHTML = `
        <input type="text" class="term-input" placeholder="Term ${count}">
        <button class="remove-btn" onclick="removeTerm(this)" title="Remove term">&times;</button>
      `;
      container.appendChild(entry);
    };

    window.removeTerm = function(btn) {
      const container = document.getElementById('termEntries');
      if (container.querySelectorAll('.term-entry').length > 2) {
        btn.parentElement.remove();
      } else {
        alert('Minimum 2 terms required');
      }
    };

    window.searchAllTerms = function() {
      const inputs = document.querySelectorAll('.term-input');
      const terms = Array.from(inputs)
        .map(input => input.value.trim())
        .filter(t => t.length > 0);

      if (terms.length < 2) {
        alert('Enter at least 2 terms');
        return;
      }

      // Collect all term data
      const termData = {};
      for (const term of terms) {
        const occurrences = elsService.findWord(term);
        termData[term] = {
          occurrences: occurrences,
          count: occurrences.length
        };
      }

      // Compute full proximity matrix (all pairs)
      const proximityPairs = [];
      for (let i = 0; i < terms.length; i++) {
        for (let j = i + 1; j < terms.length; j++) {
          const result = elsService.pairProximity(terms[i], terms[j]);
          if (result) {
            proximityPairs.push({
              term1: terms[i],
              term2: terms[j],
              distance: result.distance,
              pos1: result.word1.pos,
              skip1: result.word1.skip,
              pos2: result.word2.pos,
              skip2: result.word2.skip
            });
          }
        }
      }

      // Sort by distance
      proximityPairs.sort((a, b) => a.distance - b.distance);

      // Store results
      currentResults = {
        terms: terms,
        termData: termData,
        proximityPairs: proximityPairs,
        timestamp: new Date().toISOString()
      };

      // Display results
      displaySearchResults(currentResults);
    };

    function displaySearchResults(results) {
      const { terms, termData, proximityPairs } = results;

      // Term occurrence summary
      let summaryHtml = '<h3>Term Occurrences</h3><table class="full-results-table"><tr><th>Term</th><th>Occurrences</th><th>First Position</th></tr>';
      for (const term of terms) {
        const data = termData[term];
        const firstPos = data.occurrences.length > 0 ? data.occurrences[0].pos : 'N/A';
        summaryHtml += `<tr><td><strong>${term}</strong></td><td>${data.count.toLocaleString()}</td><td>${typeof firstPos === 'number' ? firstPos.toLocaleString() : firstPos}</td></tr>`;
      }
      summaryHtml += '</table>';

      // Proximity matrix
      const { matrix } = elsService.computeProximityMatrix(terms);
      let matrixHtml = '<h3>Proximity Matrix (minimum distance in characters)</h3>';
      matrixHtml += '<div class="proximity-matrix"><table><tr><th></th>';
      for (const term of terms) {
        matrixHtml += `<th>${term}</th>`;
      }
      matrixHtml += '</tr>';
      for (let i = 0; i < terms.length; i++) {
        matrixHtml += `<tr><th>${terms[i]}</th>`;
        for (let j = 0; j < terms.length; j++) {
          const dist = matrix[i][j];
          const cls = dist === 0 ? '' :
                      dist < 500 ? 'proximity-cell-close' :
                      dist < 2000 ? 'proximity-cell-medium' : 'proximity-cell-far';
          const displayDist = dist === Infinity ? '∞' : dist.toLocaleString();
          matrixHtml += `<td class="${cls}">${displayDist}</td>`;
        }
        matrixHtml += '</tr>';
      }
      matrixHtml += '</table></div>';
      matrixHtml += `<p style="font-size: 12px; margin-top: 10px;">
        <span style="background: #c8e6c9; padding: 2px 8px; border-radius: 3px;">< 500</span>
        <span style="background: #fff9c4; padding: 2px 8px; border-radius: 3px;">< 2000</span>
        <span style="background: #ffcdd2; padding: 2px 8px; border-radius: 3px;">> 2000</span>
      </p>`;

      // Full pair details (ALL pairs shown) - CLICKABLE ROWS
      let pairsHtml = `<h3>All Proximity Pairs (${proximityPairs.length} pairs) - Click row to view matrix</h3>`;
      pairsHtml += '<div class="results-scrollable"><table class="full-results-table">';
      pairsHtml += '<tr><th>#</th><th>Term 1</th><th>Term 2</th><th>Distance</th><th>Position 1</th><th>Skip 1</th><th>Position 2</th><th>Skip 2</th></tr>';
      proximityPairs.forEach((pair, idx) => {
        const cls = pair.distance < 500 ? 'proximity-cell-close' :
                    pair.distance < 2000 ? 'proximity-cell-medium' : 'proximity-cell-far';
        pairsHtml += `<tr class="clickable-row" onclick="showPairMatrix(${idx})" data-idx="${idx}">
          <td>${idx + 1}</td>
          <td><strong>${pair.term1}</strong></td>
          <td><strong>${pair.term2}</strong></td>
          <td class="${cls}">${pair.distance.toLocaleString()}</td>
          <td>${pair.pos1.toLocaleString()}</td>
          <td>${pair.skip1}</td>
          <td>${pair.pos2.toLocaleString()}</td>
          <td>${pair.skip2}</td>
        </tr>`;
      });
      pairsHtml += '</table></div>';

      // Matrix view area (updates when row is clicked)
      const matrixViewHtml = `
        <div id="matrixViewArea" class="matrix-view-area">
          <h3>Matrix View</h3>
          <p class="hint">Click on a proximity pair above to display its matrix view with statistics.</p>
          <div id="matrixDisplay"></div>
        </div>
      `;

      document.getElementById('searchResults').innerHTML = `
        <div class="results">
          ${summaryHtml}
          ${matrixHtml}
          ${pairsHtml}
          ${matrixViewHtml}
        </div>
      `;
    }

    // =============== Matrix View ===============

    window.showPairMatrix = function(pairIndex) {
      if (!currentResults || !torahText) return;

      const pair = currentResults.proximityPairs[pairIndex];
      if (!pair) return;

      // Highlight selected row
      document.querySelectorAll('.clickable-row').forEach(row => row.classList.remove('selected'));
      document.querySelector(`.clickable-row[data-idx="${pairIndex}"]`)?.classList.add('selected');

      // Determine matrix parameters
      const centerPos = Math.min(pair.pos1, pair.pos2);
      const matrixWidth = 30; // characters per row
      const skip = Math.abs(pair.skip1); // Use term1's skip for matrix
      const rowsBefore = 5;
      const rowsAfter = 10;

      // Calculate positions for both terms in the matrix
      const term1Positions = new Set();
      const term2Positions = new Set();

      // Get all positions for term1 at its skip
      for (let i = 0; i < pair.term1.length; i++) {
        term1Positions.add(pair.pos1 + i * pair.skip1);
      }
      // Get all positions for term2 at its skip
      for (let i = 0; i < pair.term2.length; i++) {
        term2Positions.add(pair.pos2 + i * pair.skip2);
      }

      // Build matrix HTML
      let matrixHtml = '<div class="els-matrix">';

      // Calculate start position for matrix
      const startRow = Math.floor(centerPos / matrixWidth) - rowsBefore;
      const endRow = startRow + rowsBefore + rowsAfter + 1;

      for (let row = startRow; row <= endRow; row++) {
        const rowStart = row * matrixWidth;
        if (rowStart < 0 || rowStart >= torahText.length) continue;

        let rowHtml = '';
        for (let col = 0; col < matrixWidth; col++) {
          const pos = rowStart + col;
          if (pos >= torahText.length) break;

          const char = torahText[pos];
          const inTerm1 = term1Positions.has(pos);
          const inTerm2 = term2Positions.has(pos);

          if (inTerm1 && inTerm2) {
            rowHtml += `<span class="highlight-both">${char}</span>`;
          } else if (inTerm1) {
            rowHtml += `<span class="highlight-term1">${char}</span>`;
          } else if (inTerm2) {
            rowHtml += `<span class="highlight-term2">${char}</span>`;
          } else {
            rowHtml += char;
          }
        }
        matrixHtml += rowHtml + '\\n';
      }
      matrixHtml += '</div>';

      // Statistics
      const statsHtml = `
        <div class="matrix-stats">
          <div class="matrix-stat">
            <div class="value" style="color: #e91e63;">${pair.term1}</div>
            <div class="label">Term 1</div>
          </div>
          <div class="matrix-stat">
            <div class="value" style="color: #4caf50;">${pair.term2}</div>
            <div class="label">Term 2</div>
          </div>
          <div class="matrix-stat">
            <div class="value">${pair.distance.toLocaleString()}</div>
            <div class="label">Distance</div>
          </div>
          <div class="matrix-stat">
            <div class="value">${pair.skip1}</div>
            <div class="label">Skip 1</div>
          </div>
          <div class="matrix-stat">
            <div class="value">${pair.skip2}</div>
            <div class="label">Skip 2</div>
          </div>
          <div class="matrix-stat">
            <div class="value">${pair.pos1.toLocaleString()}</div>
            <div class="label">Position 1</div>
          </div>
          <div class="matrix-stat">
            <div class="value">${pair.pos2.toLocaleString()}</div>
            <div class="label">Position 2</div>
          </div>
        </div>
        <p style="margin-top: 10px; font-size: 12px;">
          <span style="background: #e91e63; padding: 2px 6px; border-radius: 3px;">Term 1</span>
          <span style="background: #4caf50; padding: 2px 6px; border-radius: 3px;">Term 2</span>
          <span style="background: #ff9800; padding: 2px 6px; border-radius: 3px;">Overlap</span>
        </p>
      `;

      document.getElementById('matrixDisplay').innerHTML = statsHtml + matrixHtml;
    };

    // =============== Save/Load Sessions ===============

    window.saveSession = function() {
      if (!currentResults) {
        alert('No search results to save. Run a search first.');
        return;
      }

      const name = document.getElementById('sessionName').value.trim() ||
                   `Search ${new Date().toLocaleString('he-IL')}`;

      const sessions = JSON.parse(localStorage.getItem('elsSearchSessions') || '[]');
      sessions.unshift({
        name: name,
        results: currentResults,
        savedAt: new Date().toISOString()
      });

      // Keep only last 20 sessions
      if (sessions.length > 20) sessions.length = 20;

      localStorage.setItem('elsSearchSessions', JSON.stringify(sessions));
      loadSavedSearches();
      document.getElementById('sessionName').value = '';
      alert('Session saved!');
    };

    window.loadSession = function(index) {
      const sessions = JSON.parse(localStorage.getItem('elsSearchSessions') || '[]');
      if (sessions[index]) {
        const session = sessions[index];
        currentResults = session.results;

        // Restore term inputs
        const container = document.getElementById('termEntries');
        container.innerHTML = '';
        for (const term of session.results.terms) {
          const entry = document.createElement('div');
          entry.className = 'term-entry';
          entry.innerHTML = `
            <input type="text" class="term-input" value="${term}">
            <button class="remove-btn" onclick="removeTerm(this)" title="Remove term">&times;</button>
          `;
          container.appendChild(entry);
        }

        // Display results
        displaySearchResults(currentResults);
      }
    };

    window.deleteSession = function(index) {
      if (!confirm('Delete this saved session?')) return;
      const sessions = JSON.parse(localStorage.getItem('elsSearchSessions') || '[]');
      sessions.splice(index, 1);
      localStorage.setItem('elsSearchSessions', JSON.stringify(sessions));
      loadSavedSearches();
    };

    function loadSavedSearches() {
      const sessions = JSON.parse(localStorage.getItem('elsSearchSessions') || '[]');
      const container = document.getElementById('savedSearches');

      if (sessions.length === 0) {
        container.innerHTML = '<p style="font-size: 12px; color: #666; margin-top: 10px;">No saved sessions</p>';
        return;
      }

      let html = '<p style="font-size: 12px; color: #666; margin-top: 10px;">Saved Sessions:</p>';
      sessions.forEach((session, index) => {
        const date = new Date(session.savedAt).toLocaleString('he-IL');
        html += `
          <div class="saved-search-item">
            <div>
              <span class="terms">${session.name}</span><br>
              <span class="timestamp">${date} - ${session.results.terms.join(', ')}</span>
            </div>
            <div>
              <button class="btn btn-small btn-secondary" onclick="loadSession(${index})">Load</button>
              <button class="btn btn-small btn-danger" onclick="deleteSession(${index})">×</button>
            </div>
          </div>
        `;
      });
      container.innerHTML = html;
    }

    window.exportResults = function() {
      if (!currentResults) {
        alert('No results to export');
        return;
      }

      const dataStr = JSON.stringify(currentResults, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `els-search-${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
    };

    window.clearSession = function() {
      if (!confirm('Clear all terms and results?')) return;
      const container = document.getElementById('termEntries');
      container.innerHTML = `
        <div class="term-entry">
          <input type="text" class="term-input" placeholder="Term 1">
          <button class="remove-btn" onclick="removeTerm(this)" title="Remove term">&times;</button>
        </div>
        <div class="term-entry">
          <input type="text" class="term-input" placeholder="Term 2">
          <button class="remove-btn" onclick="removeTerm(this)" title="Remove term">&times;</button>
        </div>
      `;
      document.getElementById('searchResults').innerHTML = '';
      currentResults = null;
    };

    // =============== Individual Word Lookup ===============

    window.doLookup = function() {
      const word = document.getElementById('lookupWord').value.trim();
      const limit = parseInt(document.getElementById('lookupLimit').value) || 100;
      if (!word) return;

      const occurrences = elsService.findWord(word);
      const count = occurrences.length;

      if (count === 0) {
        document.getElementById('lookupResults').innerHTML =
          `<div class="results"><p>No occurrences found for "${word}"</p></div>`;
        return;
      }

      const sample = occurrences.slice(0, limit);
      let html = `
        <div class="results">
          <p><strong>${word}</strong>: ${count.toLocaleString()} total occurrences</p>
          <p style="font-size: 12px; color: #666;">Showing ${Math.min(limit, count)} of ${count}:</p>
          <div class="results-scrollable">
            <table class="full-results-table">
              <tr><th>#</th><th>Position</th><th>Skip</th></tr>
              ${sample.map((o, i) => `
                <tr>
                  <td>${i + 1}</td>
                  <td>${o.pos.toLocaleString()}</td>
                  <td>${o.skip}</td>
                </tr>
              `).join('')}
            </table>
          </div>
        </div>
      `;
      document.getElementById('lookupResults').innerHTML = html;
    };

    // =============== Proximity Search ===============

    window.doProximitySearch = function() {
      const pos = parseInt(document.getElementById('proximityPos').value);
      const radius = parseInt(document.getElementById('proximityRadius').value);
      const limit = parseInt(document.getElementById('proximityLimit').value) || 50;

      const results = elsService.findNearby(pos, radius, { minWordLength: 3, maxResults: limit });

      if (results.length === 0) {
        document.getElementById('proximityResults').innerHTML =
          `<div class="results"><p>No words found within ${radius} characters of position ${pos}</p></div>`;
        return;
      }

      const html = `
        <div class="results">
          <p>Found ${results.length} words near position ${pos.toLocaleString()}:</p>
          <div class="results-scrollable">
            <table class="full-results-table">
              <tr><th>Word</th><th>Min Distance</th><th>Nearby Count</th></tr>
              ${results.map(r => `
                <tr>
                  <td><strong>${r.word}</strong></td>
                  <td>${r.minDistance}</td>
                  <td>${r.occurrences.length}</td>
                </tr>
              `).join('')}
            </table>
          </div>
        </div>
      `;
      document.getElementById('proximityResults').innerHTML = html;
    };

    // =============== Cluster Discovery ===============

    window.doClusterDiscovery = function() {
      const seed = document.getElementById('clusterSeed').value.trim();
      const radius = parseInt(document.getElementById('clusterRadius').value);
      const limit = parseInt(document.getElementById('clusterLimit').value) || 30;

      const cluster = elsService.discoverCluster(seed, radius, { topN: limit, minWordLength: 3 });

      if (!cluster) {
        document.getElementById('clusterResults').innerHTML =
          `<div class="results"><p>Could not find "${seed}" in index</p></div>`;
        return;
      }

      const html = `
        <div class="results">
          <p><strong>Cluster around "${seed}"</strong></p>
          <p>Center: position ${cluster.center.pos.toLocaleString()} (skip ${cluster.center.skip})</p>
          <p>Centroid: position ${cluster.centroid.toLocaleString()} (shift: ${cluster.centroidShift > 0 ? '+' : ''}${cluster.centroidShift})</p>

          <div class="results-scrollable">
            <table class="full-results-table">
              <tr><th>Term</th><th>Distance</th><th>Occurrences Nearby</th></tr>
              <tr style="background: #e91e63; color: white;"><td><strong>${seed}</strong></td><td>0 (seed)</td><td>-</td></tr>
              ${cluster.words.map(w => {
                const bg = w.minDistance < 200 ? '#c8e6c9' :
                           w.minDistance < 500 ? '#fff9c4' : '#ffcdd2';
                return `<tr style="background: ${bg};">
                  <td><strong>${w.word}</strong></td>
                  <td>${w.minDistance}</td>
                  <td>${w.occurrences.length}</td>
                </tr>`;
              }).join('')}
            </table>
          </div>
        </div>
      `;
      document.getElementById('clusterResults').innerHTML = html;
    };

    // =============== Statistical Significance ===============

    window.doSignificance = function() {
      const word = document.getElementById('sigWord').value.trim();

      const stats = elsService.significanceScore(word);

      const html = `
        <div class="results">
          <p><strong>Statistical Analysis for "${word}":</strong></p>
          <div class="stats-grid" style="margin-top: 15px;">
            <div class="stat-box" style="background: ${stats.significant ? 'var(--success)' : '#999'};">
              <div class="value">${stats.observed.toLocaleString()}</div>
              <div class="label">Observed</div>
            </div>
            <div class="stat-box" style="background: #666;">
              <div class="value">${stats.expected.toLocaleString()}</div>
              <div class="label">Expected (random)</div>
            </div>
            <div class="stat-box" style="background: ${Math.abs(stats.zScore) > 2 ? 'var(--primary)' : '#999'};">
              <div class="value">${stats.zScore > 0 ? '+' : ''}${stats.zScore}</div>
              <div class="label">Z-Score</div>
            </div>
          </div>
          <p style="margin-top: 15px;">
            ${stats.significant
              ? `<strong style="color: var(--success);">Statistically significant</strong> (|z| > 2)`
              : `<span style="color: #666;">Not statistically significant</span>`}
          </p>
          ${stats.zScore > 2
            ? `<p>Word appears ${(stats.observed / stats.expected).toFixed(1)}x more often than expected by chance.</p>`
            : stats.zScore < -2
              ? `<p>Word appears ${(stats.expected / stats.observed).toFixed(1)}x less often than expected by chance.</p>`
              : ``}
        </div>
      `;
      document.getElementById('sigResults').innerHTML = html;
    };

    // Initialize on load
    init();
  </script>
</body>
</html>
