<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="img/favicon.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="styles.css">
  <title>Bible Codes</title>
  <link rel="manifest" href="manifest.json">
  <!-- Ensure the CSS is loaded before any script runs -->
</head>

<body>
  <div class="header">
    <!-- Image link that opens GitHub repo in a new tab -->
    <a href="https://github.com/bible-codes/bible-codes.github.io" target="_blank">
      <img src="img/favicon.png" alt="logo" class="logo" style="width:80px;height:80px;margin-right:15px;margin-bottom:15px;">
    </a>
    <h1>Bible Codes</h1>
    <p>Bible Codes and Data Science</p>
  </div>

  <div id="list">
    <div class="input-container">
      <button class="btn" id="search-btn"><i class="fa fa-search"></i> Search</button>
      <input dir="rtl" type="text" name="st1" id="st1" class="st" placeholder="First Search Term">
      <span class="st-label">First Search Term</span>
    </div>

    <div class="range-container">
      <label for="min-range">Min:</label>
      <input type="number" id="min-range" value="-100">
      <label for="max-range">Max:</label>
      <input type="number" id="max-range" value="100">
    </div>

    <div id="test"></div>
  </div>

  <!-- Defer JS until after the document has loaded -->
  <script src="js/test.js" defer></script>

  <script>
    // Wait for the DOM content to be fully loaded
    document.addEventListener('DOMContentLoaded', function () {
      // Service Worker registration for PWA
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function () {
          navigator.serviceWorker.register('sw.js').then(function (registration) {
            console.log('Service Worker registered with scope:', registration.scope);
          }, function (err) {
            console.log('Service Worker registration failed:', err);
          });
        });
      }

      // Correct the element IDs and handle minSkipInput being null
      const searchButton = document.querySelector('.btn');
      const searchTermInput = document.getElementById('st1');
      const minSkipInput = document.getElementById('min-range');
      const maxSkipInput = document.getElementById('max-range');
      const resultContainer = document.getElementById('test');

      // Check if elements are found before adding event listeners
      if (!minSkipInput || !maxSkipInput) {
        console.error('Input elements not found');
        return;
      }

      searchButton.addEventListener('click', () => {
        const searchTerm = searchTermInput.value.trim();
        let minSkip = parseInt(minSkipInput.value);
        let maxSkip = parseInt(maxSkipInput.value);

        if (isNaN(minSkip) || isNaN(maxSkip) || minSkip > maxSkip) {
          alert("Minimum value must be less than or equal to Maximum value.");
          minSkipInput.value = -100;
          maxSkipInput.value = 100;
          minSkip = -100;
          maxSkip = 100;
          return;
        }

        if (searchTerm === "") {
          alert("Please enter a search term.");
          return;
        }

        resultContainer.textContent = `Searching for "${searchTerm}" within range ${minSkip} to ${maxSkip}...`;
        resultContainer.style.color = "blue"; // Optional: Change color to indicate process
        const loadingMessage = document.createElement('p');
        loadingMessage.textContent = "Processing, please wait...";
        resultContainer.appendChild(loadingMessage);

        // Simulate a delay to mimic a real search process (replace this with actual searching)
        setTimeout(() => {
          const results = performELSSearchWithOptimization(searchTerm, minSkip, maxSkip);
          loadingMessage.remove(); // Remove loading message after search
          displayResults(results);
        }, 1000); // Simulated delay (1 second)
      });

      function performELSSearchWithOptimization(term, min, max) {
        const text = "mocktextfromtorah"; // Replace this with your text
        const results = [];

        const prehashTable = prehashFrequentTerms(text, term.length);

        for (let skip = min; skip <= max; skip++) {
          if (skip === 0) {
            results.push(...kmpSearch(text, term, 0));
          } else {
            results.push(...searchWithSkipOptimized(term, text, skip, prehashTable));
          }
        }
        return results;
      }

      function prehashFrequentTerms(text, length) {
        const table = {};
        for (let i = 0; i <= text.length - length; i++) {
          const substr = text.substring(i, i + length);
          table[substr] = table[substr] || [];
          table[substr].push(i);
        }
        return table;
      }

      function kmpSearch(text, pattern, skip) {
        const results = [];
        const lps = computeLPSArray(pattern);
        let i = 0;
        let j = 0;

        while (i < text.length) {
          if (pattern[j] === text[i]) {
            i++;
            j++;
          }
          if (j === pattern.length) {
            results.push(`Found "${pattern}" with skip ${skip} at index ${i - j}`);
            j = lps[j - 1];
          } else if (i < text.length && pattern[j] !== text[i]) {
            if (j !== 0) {
              j = lps[j - 1];
            } else {
              i++;
            }
          }
        }
        return results;
      }

      function computeLPSArray(pattern) {
        const lps = Array(pattern.length).fill(0);
        let length = 0;
        let i = 1;
        while (i < pattern.length) {
          if (pattern[i] === pattern[length]) {
            length++;
            lps[i] = length;
            i++;
          } else {
            if (length !== 0) {
              length = lps[length - 1];
            } else {
              lps[i] = 0;
              i++;
            }
          }
        }
        return lps;
      }

      function searchWithSkipOptimized(term, text, skip, prehashTable) {
        const results = [];
        const adjustedSkip = Math.abs(skip);
        const direction = skip > 0 ? 'right' : 'left';

        for (let i = 0; i < text.length; i++) {
          let candidate = '';

          if (prehashTable[term] && prehashTable[term].includes(i)) {
            results.push(`Found "${term}" directly from prehash with skip ${skip} starting at index ${i}`);
          } else {
            for (let j = i; j < text.length && candidate.length < term.length; j += adjustedSkip) {
              candidate += text[j];
            }
            if (candidate === term) {
              results.push(`Found "${term}" skipping ${skip} ${direction} starting at index ${i}`);
            }
          }
        }
        return results;
      }

      function displayResults(results) {
        if (results.length === 0) {
          resultContainer.innerHTML += "<br>No results found.";
        } else {
          resultContainer.innerHTML += "<br>" + results.join('<br>');
        }
      }
    });
  </script>
</body>

</html>
